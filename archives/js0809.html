<!-- build time:Sun Aug 09 2020 18:55:03 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"adameta.top",root:"/",scheme:"Gemini",version:"7.7.2",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!1,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="promise和生成器生成器基础生成器是一种特殊类型的函数，当从头到尾运行标准函数时，它最多生成一个值。"><meta property="og:type" content="article"><meta property="og:title" content="promise和生成器"><meta property="og:url" content="http://adameta.top/archives/js0809.html"><meta property="og:site_name" content="oceanlvr"><meta property="og:description" content="promise和生成器生成器基础生成器是一种特殊类型的函数，当从头到尾运行标准函数时，它最多生成一个值。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://adameta.top/archives/_v_images/20200808160035264_1586.png"><meta property="article:published_time" content="2020-08-09T10:53:44.000Z"><meta property="article:modified_time" content="2020-08-09T10:54:47.454Z"><meta property="article:author" content="oceanlvr"><meta property="article:tag" content="读书笔记"><meta property="article:tag" content="JavaScript"><meta property="article:tag" content="「你不知道的 JavaScript」"><meta property="article:tag" content="「JavaScript 忍者秘籍」"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://adameta.top/archives/_v_images/20200808160035264_1586.png"><link rel="canonical" href="http://adameta.top/archives/js0809.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><script>((w, d) => {
    'use strict';
      const userScheme = localStorage.getItem('Scheme');
      if (!userScheme) return;
    d.documentElement.className += ' darkScheme';
  })(window, document);</script><title>promise和生成器 | oceanlvr</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="oceanlvr" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">oceanlvr</span> <span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a></li><li class="menu-item menu-item-links"><a href="/links" rel="section"><i class="fa fa-fw fa-link"></i>友情链接</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="site-search"><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></div></header><div class="reading-progress-bar"></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://adameta.top/archives/js0809.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/head.png"><meta itemprop="name" content="oceanlvr"><meta itemprop="description" content="坚持写点什么"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="oceanlvr"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">promise和生成器</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-08-09 18:53:44 / 修改时间：18:54:47" itemprop="dateCreated datePublished" datetime="2020-08-09T18:53:44+08:00">2020-08-09</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a> </span></span><span id="/archives/js0809.html" class="post-meta-item leancloud_visitors" data-flag-title="promise和生成器" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/archives/js0809.html#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/archives/js0809.html" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>14k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>13 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="promise和生成器">promise和生成器</h1><h2 id="生成器基础">生成器基础</h2><p>生成器是一种特殊类型的函数，当从头到尾运行标准函数时，它最多生成一个值。</p><a id="more"></a><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成器对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">WeaponGenerator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">"1"</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">"2"</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">"3"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> weapon <span class="keyword">of</span> WeaponGenerator()) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(weapon);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>创建生成器的方法 在关键字 function 前面加上 *。调用生成器并不会调用生成器函数，而是创建一个<strong>迭代器对象</strong>。</p><h3 id="迭代器对象控制生成器">迭代器对象控制生成器</h3><p>调用生成器函数不一定会执行生成器函数体。通过创建迭代器对象，可以与生成器对象通信。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">WeaponGenerator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">"1"</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">"2"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//得到一个迭代器对象</span></span><br><span class="line"><span class="keyword">const</span> weaponsIterator = WeaponGenerator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> res = weaponsIterator.next(); <span class="comment">//调用next方法向生成器请求一个新值</span></span><br><span class="line"><span class="built_in">console</span>.assert(<span class="keyword">typeof</span> res === <span class="string">"object"</span> &amp;&amp; res.value === <span class="string">"1"</span> &amp;&amp; !res.done, <span class="string">"1"</span>);</span><br><span class="line"><span class="keyword">const</span> res1 = weaponsIterator.next();</span><br><span class="line"><span class="built_in">console</span>.assert(<span class="keyword">typeof</span> res1 === <span class="string">"object"</span> &amp;&amp; res1.value === <span class="string">"2"</span> &amp;&amp; !res1.done);</span><br><span class="line"><span class="keyword">const</span> res2 = weaponsIterator.next();</span><br><span class="line"><span class="built_in">console</span>.assert(<span class="keyword">typeof</span> res2 === <span class="string">"object"</span> &amp;&amp; res2.value === <span class="literal">undefined</span> &amp;&amp; res2.done);</span><br></pre></td></tr></table></figure><p>例子中，首先通过生成器函数生成了一个<strong>迭代器</strong>，随后对迭代器的每一个对象进行检查，总共取值 3 次，当取值第三次的时候，<code>res</code> 的值是 <code>undefined</code>。</p><p>其中，每一次调用 <code>next</code> 函数时，会返回一个对象，其中封装了结果值和一个指示完成的指示器。即 <code>value</code> 和 <code>done</code> 属性。</p><p>每当生成一个值后，生成器会<strong>非阻塞</strong>地挂起，随后等待下一次值的请求到达。</p><h3 id="生成器的迭代">生成器的迭代</h3><p>通过调用生成器得到的迭代器，暴露出一个 <code>next</code> 方法能让我们向生成器请求一个新值。</p><p><code>next</code> 方法返回一个携带着生成值的对象。而该对象中包括的另一个属性 <code>done</code> 也向我们指示了生成器是否还会返回值。</p><p>因此，我们可以有其他的写法，如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">WeaponGenerator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">"1"</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">"2"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> weaponsIterator = WeaponGenerator();</span><br><span class="line"><span class="keyword">let</span> item;</span><br><span class="line"><span class="keyword">while</span> (!(item = weaponsIterator.next()).done) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(item.value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上文中的 <code>for-of</code> 迭代即为改代码的语法糖。</p><p>迭代器迭代的语法糖版本，<code>for-of</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> weaponsIterator = WeaponGenerator();</span><br><span class="line"><span class="keyword">for</span> (weapon <span class="keyword">of</span> weaponsIterator) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(weapon);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="生成器对象交付执行权">生成器对象交付执行权</h3><p>迭代器在遍历生成器函数中的 <code>yield</code> 过程时，可以交付函数的控制权，例如在 <code>WarriorGenerator</code> 生成器函数中执行 <code>yield* NinjaGenerator();</code> 时，会把执行权交给函数迭代器 <code>NinjaGenerator</code>。当 <code>NinjaGenerator</code> 执行完成之后，又把执行权返回给 <code>WarriorGenerator</code>。</p><p>而这个过程对于 <code>for-of</code> 迭代器来说是完全透明的，也就是说对于生成器函数产生的迭代器来说，最佳的实践是使用 <code>for-of</code> 对迭代器进行迭代，而不是使用 <code>while (!(item = weaponsIterator.next()).done)</code>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">WarriorGenerator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">"1"</span>;</span><br><span class="line">  <span class="keyword">yield</span>* NinjaGenerator();</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">"4"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">NinjaGenerator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">"2"</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">"3"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> warrior <span class="keyword">of</span> WarriorGenerator()) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(warrior);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用生成器的案列">使用生成器的案列</h3><p>使用生成器生成唯一 ID 序列。</p><p>使用全局的变量可以用于生成唯一的 ID ，但是这样的写法十分的简陋，因此，需要另外一种更好的写法。即使用生成器对象。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">IdGenerator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//一个较好的 Id 生成器实践</span></span><br><span class="line">  <span class="keyword">let</span> id = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">yield</span> ++id;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> idIterator = IdGenerator();</span><br><span class="line"><span class="keyword">const</span> ninja1 = &#123;  <span class="attr">id</span>: idIterator.next().value &#125;;</span><br><span class="line"><span class="keyword">const</span> ninja2 = &#123;  <span class="attr">id</span>: idIterator.next().value &#125;;</span><br><span class="line"><span class="keyword">const</span> ninja3 = &#123;  <span class="attr">id</span>: idIterator.next().value &#125;;</span><br><span class="line"><span class="built_in">console</span>.log(ninja1.id);</span><br><span class="line"><span class="built_in">console</span>.log(ninja2.id);</span><br><span class="line"><span class="built_in">console</span>.log(ninja3.id);</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p>这样，使用生成器函数，即可优雅地生成诸多可靠的 ID 值。</p><p>在生成器中<strong>可以使用</strong>无限循环的代码，在生成器中，当生成器遇到了一个 <code>yield</code> 语句，就会一直<strong>挂起</strong>直到下次调用 <code>next</code> 方法。</p><hr><p>使用迭代器遍历 DOM 树</p><p>下面代码是使用回调函数的写法对 DOM 树进行遍历。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div id=<span class="string">"subTree"</span>&gt;</span><br><span class="line">    &lt;form action=<span class="string">"en"</span>&gt;</span><br><span class="line">      &lt;input type=<span class="string">"text"</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/form&gt;</span></span><br><span class="line"><span class="regexp">    &lt;p&gt;Paragraph&lt;/</span>p&gt;</span><br><span class="line">    &lt;span&gt;Span&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;</span><br><span class="line">  &lt;script&gt;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">traverseDOM</span>(<span class="params">element, callback</span>) </span>&#123;</span><br><span class="line">      callback(element);</span><br><span class="line">      element = element.firstElementChild;</span><br><span class="line">      <span class="keyword">while</span> (element) &#123;</span><br><span class="line">        traverseDOM(element, callback);</span><br><span class="line">        element = element.nextElementSibling;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> subTree = <span class="built_in">document</span>.getElementById(<span class="string">"subTree"</span>);</span><br><span class="line">    traverseDOM(subTree, <span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(element.nodeName);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    DIV</span></span><br><span class="line"><span class="comment">    FORM</span></span><br><span class="line"><span class="comment">    INPUT</span></span><br><span class="line"><span class="comment">    P</span></span><br><span class="line"><span class="comment">    SPAN</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  &lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br></pre></td></tr></table></figure><p>首先获得 subTree 节点。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> subTree = <span class="built_in">document</span>.getElementById(<span class="string">"subTree"</span>);</span><br></pre></td></tr></table></figure><p>随后使用了一个 callback 回调函数处理每一个节点，element 元素是待遍历的节点。对于函数中，使用了两个关键的 DOM API</p><ul><li>firstElementChild ，用于查找节点的第一个子节点</li><li>nextElementSibling，用于查找该节点的兄弟节点</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">traverseDOM</span>(<span class="params">element, callback</span>) </span>&#123;</span><br><span class="line">      callback(element);</span><br><span class="line">      element = element.firstElementChild;</span><br><span class="line">      <span class="keyword">while</span> (element) &#123;</span><br><span class="line">        traverseDOM(element, callback);</span><br><span class="line">        element = element.nextElementSibling;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>上文中使用的回调函数的技术，还可以使用生成器函数实现。</p><p>以下是代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">DomTraversal</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> element;<span class="comment">//返回原节点</span></span><br><span class="line">  element = element.firstElementChild;<span class="comment">//获得第一个节点</span></span><br><span class="line">  <span class="keyword">while</span> (element) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">yield</span>* DomTraversal(element);</span><br><span class="line">    element = element.nextElementSibling;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> subTree = <span class="built_in">document</span>.getElementById(<span class="string">"subTree"</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> element <span class="keyword">of</span> DomTraversal(subTree)) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(element.nodeName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">DIV</span></span><br><span class="line"><span class="comment">FORM</span></span><br><span class="line"><span class="comment">INPUT</span></span><br><span class="line"><span class="comment">P</span></span><br><span class="line"><span class="comment">SPAN</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>使用生成器对象相比于使用回调函数，可以解耦代码。从而将生产值的代码和消费值的代码分开。</p><h3 id="生成器原理">生成器原理</h3><p>一个生成器调用之后并不会立刻执行它，相反，它会创建一个新的迭代器。通过迭代器来获得生成器中请求得到的值。因此，生成器类似一个在状态中运动的状态机。它有以下的状态</p><ul><li>挂起开始——创建一个生成器后，最先以这种方式开始。其中的任意代码都未开始执行</li><li>执行——生成器中的代码的执行的状态。执行过程要么是刚刚开始，要么是从上次挂起的地方继续的。当生成器对应的迭代器调用了 <code>next</code> 方法，并且当前存在可执行的代码时，生成器都会转移到这个状态</li><li>挂起过渡——当生成器在执行过程中遇到一个<code>yield</code> 表达式，它会创建一个包含有返回值的新对象，随后再次挂起执行。生成器在这个状态暂停并且等待执行。</li><li>完成——在生成器执行期间，如果代码执行到 <code>return</code> 语句或者全部代码执行完毕。生成器就进入这个状态</li></ul><h2 id="生成器交互">生成器交互</h2><p>生成器不光支持从 <code>yield</code> 表达式返回值，而且支持向生成器发送值。从而实现双向通信。</p><h3 id="使用生成器函数发送值">使用生成器函数发送值</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">NinjaGenerator</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> importer = <span class="keyword">yield</span>(<span class="string">"初始化传入的是 "</span> + action);</span><br><span class="line">  <span class="built_in">console</span>.assert(importer === <span class="string">"传入的值foo"</span>, <span class="string">"和生成器函数交互"</span>);</span><br><span class="line">  <span class="keyword">yield</span>(<span class="string">"传出的部分 "</span> + importer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> ninjaIterator = NinjaGenerator(<span class="string">"action"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> res1 = ninjaIterator.next();</span><br><span class="line"><span class="built_in">console</span>.assert(res1.value === <span class="string">"初始化传入的是 action"</span>, <span class="string">"成功得到传出的值"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> res2 = ninjaIterator.next(<span class="string">"传入的值foo"</span>);</span><br><span class="line"><span class="built_in">console</span>.assert(res2.value===<span class="string">"传出的部分 传入的值foo"</span>,<span class="string">"成功传值"</span>);</span><br></pre></td></tr></table></figure><p>上述代码中：</p><ol type="1"><li>初始化一个 <code>ninjaIterator</code> 迭代器对象，参数是 <code>action</code></li><li>参数 <code>action</code> 初始化 <code>action</code> 形式参数</li><li><code>res1</code> 调用 <code>ninjaIterator.next()</code> ，到达 <code>yield</code> 关键词，并且传出 <code>初始化传入的是 action</code> 这个参数</li><li>随后，初始化变量 <code>res2</code> ，其中传入的参数是 <code>传入的值foo</code></li><li>此时迭代器执行<strong>被挂起的生成器函数</strong>，执行了 <code>yield</code> 到 <code>importer</code> 的赋值部分</li><li><code>assert</code> 判断成立，参数传入正确，是 <code>传入的值foo</code></li><li><code>yield</code> 传出参数 <code>传出的部分 传入的值foo</code></li></ol><p>除了在第一次初始化过程中可以传入参数，我们还可以在每次调用 <code>next</code> 方法时传入。</p><p>在上述代码中，有几个要点要注意：</p><ol type="1"><li>可以使用 <code>function* NinjaGenerator(参数)</code> 的方式初始化</li><li>next 可以为等待中的 yield 表达式提供值。因此，如果没有等待中的 <code>yield</code> 表达式，也就没有值可以传递。因此，上述代码中，我们的第一个 <code>next</code> 代码中没有传值，（因为还没有被挂起的 <code>yield</code>）</li><li>如果需要为生成器提供一个初始值，可以调用生成器自身，例如代码 <code>NinjaGenerator(&quot;action&quot;)</code></li></ol><h3 id="抛出异常向生成器发送值非正规做法">抛出异常向生成器发送值（非正规做法）</h3><p>除了使用迭代器的 <code>next</code> 方法，还可以使用 <code>throw</code> 方法向生成器发送值。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">NinjaGenerator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">yield</span>(<span class="string">"1"</span>);</span><br><span class="line">    fail(<span class="string">"这里的错误不会发送"</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="comment">//catch 到这个值</span></span><br><span class="line">    <span class="built_in">console</span>.log(e === <span class="string">"捕获了这个异常"</span>); <span class="comment">//true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> ninjaIterator = NinjaGenerator();</span><br><span class="line"><span class="keyword">const</span> res1 = ninjaIterator.next();<span class="comment">//从生成器拉取一个值</span></span><br><span class="line"><span class="built_in">console</span>.log(res1.value); <span class="comment">//1</span></span><br><span class="line">ninjaIterator.throw(<span class="string">"捕获了这个异常"</span>); <span class="comment">//向生成器发送值</span></span><br></pre></td></tr></table></figure><h2 id="promise-初步">promise 初步</h2><p>ES6 为了解决异步处理回调函数混乱的问题，引入了 promise 函数</p><p><img src="_v_images/20200808160035264_1586.png"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//pending 准备阶段</span></span><br><span class="line"><span class="comment">//resolved 成功状态</span></span><br><span class="line"><span class="comment">//rejected 拒绝状态</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  resolve(<span class="string">"操作成功"</span>); <span class="comment">//成功-&gt;用于通知</span></span><br><span class="line">  <span class="comment">// reject("调用失败");</span></span><br><span class="line">&#125;).then(</span><br><span class="line">  value =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value); <span class="comment">//操作成功</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'成功，处理了函数'</span>); <span class="comment">//成功，处理了函数</span></span><br><span class="line">  &#125;, reason =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(reason); <span class="comment">//调用失败</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'拒绝，处理了函数'</span>); <span class="comment">//拒绝，处理了函数</span></span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>Promise 函数中，有两个部分。</p><ul><li>new 产生对象部分</li><li>then 部分</li></ul><p>上述代码等效于下面的写法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//pending 准备阶段</span></span><br><span class="line"><span class="comment">//resolved 成功状态</span></span><br><span class="line"><span class="comment">//rejected 拒绝状态</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myPromise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  resolve(<span class="string">"操作成功"</span>); <span class="comment">//成功-&gt;用于通知</span></span><br><span class="line">  <span class="comment">// reject("调用失败");</span></span><br><span class="line">&#125;);</span><br><span class="line">myPromise.then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"success"</span>);</span><br><span class="line">&#125;, res =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"fail"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//success</span></span><br></pre></td></tr></table></figure><p>首先这个函数执行的是未实现状态。这个执行过程，我们承诺会得到一个结果。</p><p>如果结果能够得到实现，就会转入已完成状态，有以下两种情况：</p><ul><li>完成状态，成功执行并且返回数据</li><li>拒绝状态，因为 <code>reject</code> 或者异常引起</li></ul><hr><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"代码开始"</span>);</span><br><span class="line"><span class="keyword">let</span> ninjaDelay = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"执行延时 promise 函数"</span>);</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"执行 delay 函数中"</span>);</span><br><span class="line">    resolve(<span class="string">"延时函数的数据"</span>);</span><br><span class="line">  &#125;, <span class="number">500</span>)</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"现在的ninjaDelay "</span> + ninjaDelay);</span><br><span class="line">ninjaDelay.then(<span class="function"><span class="params">ninja</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"数据"</span> + ninja);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//-------------------------------------</span></span><br><span class="line"><span class="keyword">const</span> ninjaImmediate = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"立即执行 promise 函数"</span>);</span><br><span class="line">  resolve(<span class="string">"立即函数的数据"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">ninjaImmediate.then(<span class="function"><span class="params">ninja</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"数据"</span> + ninja);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"代码结束"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">代码开始</span></span><br><span class="line"><span class="comment">执行延时 promise 函数</span></span><br><span class="line"><span class="comment">现在的ninjaDelay </span></span><br><span class="line"><span class="comment">立即执行 promise 函数</span></span><br><span class="line"><span class="comment">代码结束</span></span><br><span class="line"><span class="comment">数据立即函数的数据</span></span><br><span class="line"><span class="comment">执行 delay 函数中</span></span><br><span class="line"><span class="comment">数据延时函数的数据</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>观察输出，首先进行的是 pending 准备阶段的函数部分执行，之后等待到代码结束，出现 <code>代码结束</code> 的输出时，才开始执行 <code>then</code> 部分的代码。输出的是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">数据立即函数的数据</span><br><span class="line">执行 delay 函数中</span><br><span class="line">数据延时函数的数据</span><br></pre></td></tr></table></figure><p>JavaScript 通过本次事件循环中的所有代码都执行完毕以后，调用 <code>then</code> 回调来处理之前的 <code>promise</code>。</p><p>就好像在说：嘿，我承诺我会完成这部分代码的，不管它的结果如何，你最后总能得到这份代码的执行。</p><h2 id="拒绝-promise">拒绝 promise</h2><p>拒绝 promise 有两种方式：</p><ul><li>显式拒绝，在一个 promise 执行函数中调用 reject 方法</li><li>隐式拒绝，正在处理一个 promise 的过程中抛出了一个异常</li></ul><h3 id="显式拒绝">显式拒绝</h3><p>显式拒绝 promise</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  reject(<span class="string">"显式地拒绝一个promise"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">promise.then(</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    fail(<span class="string">"这里不会被调用"</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  error =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"被显式拒绝，调用回调函数"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">//被显式拒绝，调用回调函数</span></span><br></pre></td></tr></table></figure><hr><p><strong>链式调用</strong> catch 方法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">  reject(<span class="string">"显式拒绝一个 promise"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">promise.then(<span class="function"><span class="params">()</span>=&gt;</span> fail(<span class="string">"这里不会被执行"</span>))</span><br><span class="line">.catch(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"promise 被显式拒绝，通过catch方式"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//promise 被显式拒绝，通过catch方式</span></span><br></pre></td></tr></table></figure><hr><h3 id="隐式拒绝">隐式拒绝</h3><p>异常隐式拒绝一个 promise</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  undeclaredVariable++;</span><br><span class="line">&#125;);</span><br><span class="line">promise.then(<span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">  fail(<span class="string">"不会被调用"</span>)).catch(<span class="function"><span class="params">error</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"发生了异常，调用第二个异常函数"</span>));</span><br><span class="line"><span class="comment">//发生了异常，调用第二个异常函数</span></span><br></pre></td></tr></table></figure><p>在 promise 函数体内，尝试对一个没有声明的变量 <code>undeclaredVariable</code> 做自增，该变量没有在程序中定义。因此，引发了一个异常，因此引发了 <code>catch</code> 部分语句的执行。</p><h2 id="创建一个-promise-实例">创建一个 promise 实例</h2><p>客户端最常用的异步任务就是从服务器获得数据。</p><p>使用内置的 XMLHttpRequest 对象来完成底层的实现。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getjson</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//创建一个 XMLHttpRequest 对象</span></span><br><span class="line">    <span class="keyword">const</span> request = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    <span class="comment">//初始化一个请求</span></span><br><span class="line">    request.open(<span class="string">"GET"</span>, url);</span><br><span class="line">    request.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//成功请求连接</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="comment">//传递解析的数据</span></span><br><span class="line">          resolve(<span class="built_in">JSON</span>.parse(<span class="keyword">this</span>.response));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          reject(<span class="keyword">this</span>.status + <span class="string">" "</span> + <span class="keyword">this</span>.statusText);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        reject(e.message);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    request.onerror = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      reject(<span class="keyword">this</span>.status + <span class="string">" "</span> + <span class="keyword">this</span>.statusText);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    request.send();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">getjson(<span class="string">"ninja.json"</span>).then(<span class="function"><span class="params">ninjas</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(ninjas);</span><br><span class="line">&#125;).catch(<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"不会达到这段代码"</span>));</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">&#123;name: "John Johnson"&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><h3 id="使用链式调用">使用链式调用</h3><p>有以下三个 json 文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ninja1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;John Johnson&quot;,</span><br><span class="line">  &quot;year&quot;: 18,</span><br><span class="line">  &quot;des&quot;: &#123;</span><br><span class="line">    &quot;val&quot;: &quot;a person&quot;,</span><br><span class="line">    &quot;val1&quot;: &quot;other&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;url&quot;: &quot;ninja2.json&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ninja2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;oyx&quot;,</span><br><span class="line">  &quot;year&quot;: 18,</span><br><span class="line">  &quot;des&quot;: &#123;</span><br><span class="line">    &quot;val&quot;: &quot;a person&quot;,</span><br><span class="line">    &quot;val1&quot;: &quot;other&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;url&quot;: &quot;ninja3.json&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ninja3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;oceanlvr&quot;,</span><br><span class="line">  &quot;year&quot;: 18,</span><br><span class="line">  &quot;des&quot;: &#123;</span><br><span class="line">    &quot;val&quot;: &quot;a person&quot;,</span><br><span class="line">    &quot;val1&quot;: &quot;other&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;url&quot;: &quot;ninja3.json&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getJSON</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//创建一个 XMLHttpRequest 对象</span></span><br><span class="line">    <span class="keyword">const</span> request = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    <span class="comment">//初始化一个请求</span></span><br><span class="line">    request.open(<span class="string">"GET"</span>, url);</span><br><span class="line">    request.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//成功请求连接</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="comment">//传递解析的数据</span></span><br><span class="line">          resolve(<span class="built_in">JSON</span>.parse(<span class="keyword">this</span>.response));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          reject(<span class="keyword">this</span>.status + <span class="string">" "</span> + <span class="keyword">this</span>.statusText);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        reject(e.message);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    request.onerror = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      reject(<span class="keyword">this</span>.status + <span class="string">" "</span> + <span class="keyword">this</span>.statusText);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    request.send();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">getJSON(<span class="string">"ninja1.json"</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">ninjas1</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(ninjas1.url);</span><br><span class="line">    <span class="keyword">return</span> getJSON(ninjas1.url);</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">ninjas2</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(ninjas2.url);</span><br><span class="line">    <span class="keyword">return</span> getJSON(ninjas2.url);</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">ninjas3</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(ninjas3.name);</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">error</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"发生错误"</span>));</span><br></pre></td></tr></table></figure><p>使用链式调用，即每一个 then 都返回一个新的 promise 对象，使得当前的 promise then 是一个链式调用的过程。</p><p>如果一切顺利，ninja1 中的 url 属性会传递给 getJSON 生成一个新的 promise 对象，之后这个新的 promise 对象（ninja2）中的 url 会传递给下一个对象。</p><p>过程中任何出现的错误都会被 catch 捕捉到。</p><p>这样的链式嵌套的 promise 写法相对于回调函数的嵌套写法有很大的优势，即不会在捕获错误上有很大的工程，并且执行到哪一个步骤也会很清晰。</p><h3 id="等待多个promise">等待多个promise</h3><p>promise 可以处理并行的 promise 步骤的，方法是使用 Promise.all 方法。</p><p>如下，同时处理上文中的三个 json 文件。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getJSON</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//创建一个 XMLHttpRequest 对象</span></span><br><span class="line">    <span class="keyword">const</span> request = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    <span class="comment">//初始化一个请求</span></span><br><span class="line">    request.open(<span class="string">"GET"</span>, url);</span><br><span class="line">    request.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//成功请求连接</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="comment">//传递解析的数据</span></span><br><span class="line">          resolve(<span class="built_in">JSON</span>.parse(<span class="keyword">this</span>.response));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          reject(<span class="keyword">this</span>.status + <span class="string">" "</span> + <span class="keyword">this</span>.statusText);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        reject(e.message);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    request.onerror = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      reject(<span class="keyword">this</span>.status + <span class="string">" "</span> + <span class="keyword">this</span>.statusText);</span><br><span class="line">    &#125;;</span><br><span class="line">    request.send();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.all([getJSON(<span class="string">"ninja1.json"</span>),</span><br><span class="line">  getJSON(<span class="string">"ninja2.json"</span>),</span><br><span class="line">  getJSON(<span class="string">"ninja3.json"</span>)</span><br><span class="line">]).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> ninja1 = res[<span class="number">0</span>],</span><br><span class="line">    ninja2 = res[<span class="number">1</span>],</span><br><span class="line">    ninja3 = res[<span class="number">2</span>];</span><br><span class="line">  <span class="built_in">console</span>.log(ninja1, ninja2, ninja3);</span><br><span class="line">&#125;).catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"some error"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>这个并行的 Promise 中，同时并行处理了三个 json 文件，并且把结果返回给 res 数组。</p><p>只要三个文件任意一个没有被处理成功，就会返回到 catch 部分，传入 all 方法的每一个 promise 对象都和数组 res 的每一个对象在下标上一一对应。</p><h3 id="等待一个promise">等待一个promise</h3><p>上面的 all 方法会等待所有的 Promise 都完成之后才返回数据，如果是只需要第一个成功即返回数据，则可以使用 race 方法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getJSON</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//创建一个 XMLHttpRequest 对象</span></span><br><span class="line">    <span class="keyword">const</span> request = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    <span class="comment">//初始化一个请求</span></span><br><span class="line">    request.open(<span class="string">"GET"</span>, url);</span><br><span class="line">    request.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//成功请求连接</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="comment">//传递解析的数据</span></span><br><span class="line">          resolve(<span class="built_in">JSON</span>.parse(<span class="keyword">this</span>.response));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          reject(<span class="keyword">this</span>.status + <span class="string">" "</span> + <span class="keyword">this</span>.statusText);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        reject(e.message);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    request.onerror = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      reject(<span class="keyword">this</span>.status + <span class="string">" "</span> + <span class="keyword">this</span>.statusText);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    request.send();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.race([</span><br><span class="line">  getJSON(<span class="string">"ninja1.json"</span>),</span><br><span class="line">  getJSON(<span class="string">"ninja2.json"</span>),</span><br><span class="line">  getJSON(<span class="string">"ninja3.json"</span>)</span><br><span class="line">]).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//只会返回第一个成功的数据</span></span><br><span class="line">  <span class="built_in">console</span>.log(res); <span class="comment">//只返回了 ninja1.json 的数据</span></span><br><span class="line">&#125;).catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"some error"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="生成器和promise结合的异步代码">生成器和promise结合的异步代码</h2><p>异步过程中，如果前后有依赖关系，会使得 UI 阻塞（时间花费去处理 JavaScript 代码）。</p><p>而使用生成器的让渡挂起并不会引起阻塞，只需要使用 next 即可立刻唤醒生成器函数。</p><p>而 promise 在未来触发某种条件的情况下让我们得到它事先承诺的值，而且当错误发生后也会执行响应的回调函数。</p><p>思路是：把异步任务放入一个生成器中，然后执行生成器函数，在执行生成器函数的过程中，每当遇到一个异步的任务，就会创建一个 promise 用于代表该异步任务的执行结果。因为不知道上面时候能够兑现 promise。因此在生成器执行的过程中，执行权会被让渡给生成器，从而不会导致阻塞，当 promise 被兑现时，我们会继续通过迭代器的 next 方法执行生成器。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getJSON</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//创建一个 XMLHttpRequest 对象</span></span><br><span class="line">    <span class="keyword">const</span> request = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    <span class="comment">//初始化一个请求</span></span><br><span class="line">    request.open(<span class="string">"GET"</span>, url);</span><br><span class="line">    request.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//成功请求连接</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="comment">//传递解析的数据</span></span><br><span class="line">          resolve(<span class="built_in">JSON</span>.parse(<span class="keyword">this</span>.response));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          reject(<span class="keyword">this</span>.status + <span class="string">" "</span> + <span class="keyword">this</span>.statusText);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        reject(e.message);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    request.onerror = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      reject(<span class="keyword">this</span>.status + <span class="string">" "</span> + <span class="keyword">this</span>.statusText);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    request.send();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 注意 这里的回调函数是生成器函数</span></span><br><span class="line"><span class="keyword">async</span> (<span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ninja1 = <span class="keyword">yield</span> getJSON(<span class="string">"ninja1.json"</span>);</span><br><span class="line">    <span class="keyword">const</span> ninja2 = <span class="keyword">yield</span> getJSON(ninja1.url);</span><br><span class="line">    <span class="keyword">const</span> ninja3 = <span class="keyword">yield</span> getJSON(ninja2.url);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e.message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//辅助的函数 用于我们定义的生成器操作</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">async</span> (<span class="params">generator</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//使用生成器函数创建一个迭代器 进而可以控制一个迭代器</span></span><br><span class="line">  <span class="keyword">var</span> iterator = generator();</span><br><span class="line">  <span class="comment">//控制的函数 handle 用于对生成器产生的每一个值进行处理</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">iteratorResult</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//如果迭代器已经没有更多的返回结果，此时退出</span></span><br><span class="line">    <span class="keyword">if</span> (iteratorResult.done) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//获得迭代器的值</span></span><br><span class="line">    <span class="keyword">const</span> iteratorValue = iteratorResult.value;</span><br><span class="line">    <span class="comment">//如果迭代器的值是一个 Promise 对象即开始处理</span></span><br><span class="line">    <span class="keyword">if</span> (iteratorValue <span class="keyword">instanceof</span> <span class="built_in">Promise</span>) &#123;</span><br><span class="line">      <span class="comment">//通过 next 向迭代器传入值 res (迭代器的值传入) 提供给下一个 getJSON 使用</span></span><br><span class="line">      iteratorValue.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(res); <span class="comment">//输出中间结果</span></span><br><span class="line">          <span class="keyword">return</span> handle(iterator.next(res));</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(<span class="function"><span class="params">error</span> =&gt;</span> iterator.throw(error));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//执行的部分</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    handle(iterator.next());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    iterator.throw(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="post-body"><div class="note primary"><div class="popular-posts-header">猜你喜欢</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="\archives\js0410.html" rel="bookmark">JavaScript 闭包</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="\archives\js0802.html" rel="bookmark">JavaScript 函数进阶</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="\archives\js0801.html" rel="bookmark">this 绑定初步</a></div></li></ul></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>oceanlvr</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="http://adameta.top/archives/js0809.html" title="promise和生成器">http://adameta.top/archives/js0809.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"><p>欢迎关注我的其它发布渠道</p><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="https://t.me/oceanlvr" rel="external nofollow noreferrer"><span class="icon"><i class="fa fa-telegram"></i> </span><span class="label">Telegram</span></a></div><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i> </span><span class="label">RSS</span></a></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag"># 读书笔记</a> <a href="/tags/JavaScript/" rel="tag"># JavaScript</a> <a href="/tags/%E3%80%8C%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84-JavaScript%E3%80%8D/" rel="tag"># 「你不知道的 JavaScript」</a> <a href="/tags/%E3%80%8CJavaScript-%E5%BF%8D%E8%80%85%E7%A7%98%E7%B1%8D%E3%80%8D/" rel="tag"># 「JavaScript 忍者秘籍」</a></div><div class="post-nav"><div class="post-nav-item"><a href="/archives/js0802.html" rel="prev" title="JavaScript 函数进阶"><i class="fa fa-chevron-left"></i> JavaScript 函数进阶</a></div><div class="post-nav-item"></div></div></footer></article></div></div><div class="comments" id="valine-comments"></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#promise和生成器"><span class="nav-number">1.</span> <span class="nav-text">promise和生成器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#生成器基础"><span class="nav-number">1.1.</span> <span class="nav-text">生成器基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#迭代器对象控制生成器"><span class="nav-number">1.1.1.</span> <span class="nav-text">迭代器对象控制生成器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成器的迭代"><span class="nav-number">1.1.2.</span> <span class="nav-text">生成器的迭代</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成器对象交付执行权"><span class="nav-number">1.1.3.</span> <span class="nav-text">生成器对象交付执行权</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用生成器的案列"><span class="nav-number">1.1.4.</span> <span class="nav-text">使用生成器的案列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成器原理"><span class="nav-number">1.1.5.</span> <span class="nav-text">生成器原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生成器交互"><span class="nav-number">1.2.</span> <span class="nav-text">生成器交互</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用生成器函数发送值"><span class="nav-number">1.2.1.</span> <span class="nav-text">使用生成器函数发送值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#抛出异常向生成器发送值非正规做法"><span class="nav-number">1.2.2.</span> <span class="nav-text">抛出异常向生成器发送值（非正规做法）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#promise-初步"><span class="nav-number">1.3.</span> <span class="nav-text">promise 初步</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#拒绝-promise"><span class="nav-number">1.4.</span> <span class="nav-text">拒绝 promise</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#显式拒绝"><span class="nav-number">1.4.1.</span> <span class="nav-text">显式拒绝</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#隐式拒绝"><span class="nav-number">1.4.2.</span> <span class="nav-text">隐式拒绝</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建一个-promise-实例"><span class="nav-number">1.5.</span> <span class="nav-text">创建一个 promise 实例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用链式调用"><span class="nav-number">1.5.1.</span> <span class="nav-text">使用链式调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#等待多个promise"><span class="nav-number">1.5.2.</span> <span class="nav-text">等待多个promise</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#等待一个promise"><span class="nav-number">1.5.3.</span> <span class="nav-text">等待一个promise</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生成器和promise结合的异步代码"><span class="nav-number">1.6.</span> <span class="nav-text">生成器和promise结合的异步代码</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="oceanlvr" src="/images/head.png"><p class="site-author-name" itemprop="name">oceanlvr</p><div class="site-description" itemprop="description">坚持写点什么</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">27</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">26</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">25</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/oceanlvr" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;oceanlvr" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:oceanlvr@foxmail.com" title="E-Mail → mailto:oceanlvr@foxmail.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div><div class="night-mode motion-element"><a role="button" class="night-btn"><i class="fa fa-lightbulb-o"></i> Night Mode</a></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-history fa-" aria-hidden="true"></i> 近期文章</div><ul class="links-of-blogroll-list"><li><a href="/archives/js0809.html" title="promise和生成器" target="_blank">promise和生成器</a></li><li><a href="/archives/js0802.html" title="JavaScript 函数进阶" target="_blank">JavaScript 函数进阶</a></li><li><a href="/archives/js0801.html" title="this 绑定初步" target="_blank">this 绑定初步</a></li><li><a href="/archives/LinuxStaticIP.html" title="Linux 虚拟机固定IP" target="_blank">Linux 虚拟机固定IP</a></li><li><a href="/archives/js0415.html" title="JavaScript this和箭头函数" target="_blank">JavaScript this和箭头函数</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2020</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">oceanlvr</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span title="站点总字数">113k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">1:43</span></div><div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener external nofollow noreferrer" target="_blank">NexT.Gemini</a></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script><script>window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'http://adameta.top/archives/js0809.html',]
      });
      });</script><script>((w, d) => {
    'use strict';
      let userScheme = localStorage.getItem('Scheme');
      if (userScheme) d.documentElement.className += ' darkScheme';
      const btn = d.querySelector('.night-btn');
      w.addEventListener('keydown', e => {
        if (e.altKey && e.code === 'KeyX') btn.click();
      });
      btn.addEventListener('click', () => {
        d.documentElement.classList.toggle('darkScheme');
        if ( d.documentElement.classList.contains('darkScheme') ) {
          localStorage.setItem('Scheme', 'Dark');
          return;
        }
        localStorage.removeItem('Scheme');
      });
  })(window, document);</script><script>NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'NsCD849CRo7rnYNSi2EXW9rW-gzGzoHsz',
      appKey     : 'AR1dKSCcJdfSOd3uMIFq2uQS',
      placeholder: "请在此留言",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});</script><div class="moon-menu"><div class="moon-menu-items"><div class="moon-menu-item" onclick="back2bottom()"><i class="fa fa-chevron-down"></i></div><div class="moon-menu-item" onclick="back2top()"><i class="fa fa-chevron-up"></i></div></div><div class="moon-menu-button" onclick="moonMenuClick()"><svg class="moon-menu-svg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle><g class="moon-menu-points"><circle class="moon-menu-point" r=".2rem" cx="0" cy="-.8rem"></circle><circle class="moon-menu-point" r=".2rem"></circle><circle class="moon-menu-point" r=".2rem" cx="0" cy=".8rem"></circle></g></svg><div class="moon-menu-icon"></div><div class="moon-menu-text"></div></div></div><script src="/js/injector.js"></script></body></html><!-- rebuild by neat -->